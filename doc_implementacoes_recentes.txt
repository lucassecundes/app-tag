# Documentação Técnica - Atualizações Recentes (Mobile & Supabase)
Data: 12/01/2026
Destinatário: Equipe de Desenvolvimento Web / Backend

Este documento resume as recentes implementações realizadas no aplicativo móvel e as alterações necessárias/realizadas no Supabase para garantir a sincronia com o painel web.

## 1. Banco de Dados (Supabase)

### 1.1 Nova Tabela: `in_app_notifications`
Utilizada para enviar comunicados, alertas de manutenção e avisos de atualização para o app. O painel web deve ter uma interface para criar/gerenciar esses registros.

**Estrutura:**
```sql
create table public.in_app_notifications (
  id uuid default gen_random_uuid() primary key,
  title text not null,
  message text not null,
  type text check (type in ('info', 'warning', 'error')) default 'info',
  target_version text, -- Ex: '1.0.0'
  condition text check (condition in ('equal', 'less_than', 'all')) default 'all',
  is_active boolean default true,
  created_by uuid references auth.users(id),
  created_at timestamp with time zone default now()
);
```

### 1.2 Controle de Acesso (RBAC)
Foi implementada a verificação de papel (Role-Based Access Control) na tabela `usuario`.

**Campo Crítico:**
- Tabela: `public.usuario`
- Coluna: `role` (text) -> Valores: `'user'`, `'admin'`.

**Regra de Negócio:**
- Usuários com `role = 'admin'` possuem automaticamente acesso **Premium** no aplicativo (todas as features liberadas).
- Admins visualizam botões exclusivos de suporte técnico no App (Simular rota, Filtrar usuário).

### 1.3 Chat e Inteligência Artificial (Novo)
Novas tabelas para suporte ao sistema de Chat IA integrado com OpenAI.

**Tabelas:**
- `public.chat_history`: Armazena o histórico de mensagens (user/assistant) para auditoria.
- `public.chat_prompts`: Armazena o **System Prompt** do agente de IA (configurável pelo admin no Web).
- `public.visited_addresses`: Armazena locais visitados com frequência para consultas da IA.

---

## 2. Funcionalidades Implementadas (Lógica para Web replicar)

### 2.1 Simulação de Movimento (Ferramenta de Suporte)
No app, administradores podem "simular" o movimento de um dispositivo para testar a atualização em tempo real e o funcionamento dos mapas.

**Fluxo de Dados:**
1. INSERT na tabela `historico_tags`.
2. UPDATE na tabela `tags` (colunas `ultima_lat`, `ultima_lng`, `ultima_comunicacao`).

### 2.2 Filtro de Dispositivos por Usuário (Admin View)
No app, o administrador pode visualizar os dispositivos de qualquer usuário inserindo o UUID.

### 2.3 Assistente Virtual IA (OpenAI)
Integração com a OpenAI API (`gpt-3.5-turbo`) utilizando **Function Calling** para consultas reais ao banco de dados.

**Capacidades do Agente:**
- Listar dispositivos do usuário (lê da tabela `tags`).
- Consultar localização atual de um veículo específico.
- Responder dúvidas de suporte baseadas no prompt configurado.

**Segurança:**
- **Rate Limiting:** Máximo de 10 mensagens por minuto por usuário.
- **Premium Only:** Feature restrita a assinantes premium ou admins.

---

## 3. Interface e UX (Mobile)

### 3.1 Banner de Notificações
Componente no topo das abas principais para avisos ativos.

### 3.2 Melhorias de Layout
Ajustes de Safe Area no Android e exibição dinâmica do primeiro nome do usuário no Header.

### 3.3 Interface de Chat IA
- **Fresh Session:** A conversa reinicia automaticamente ao entrar na tela ou fechar o app.
- **Feedback Visual:** Animação de "Digitando..." enquanto aguarda resposta da API.
- **Welcome View:** Tela de boas-vindas para a primeira interação ("Bem-vindo a TAGPRO+ IA").
- **Quick Prompts:** Chips horizontais com perguntas frequentes para facilitar o uso.

---

## 4. Próximos Passos Sugeridos para Web

1. **CRUD de Notificações:** Gerenciar a tabela `in_app_notifications`.
2. **Visualização de Admin:** dashboard para visualizar/editar dados de todos os usuários.
3. **Gestão de IA (Crítico):** Criar interface para o administrador editar o texto na tabela `chat_prompts`. Este texto define como a IA se comporta e quais informações ela prioriza ao responder os clientes.
